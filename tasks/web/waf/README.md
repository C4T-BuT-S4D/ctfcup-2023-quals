# web | waf

## Information

> В 2196 году ты не попадешь в кибервойска если не решишь вот эту задачу.
>
> You won't get into cyberforce in 2196 if you don't solve this task.

## Deploy

Need whale deployment.

Image: `cr.yandex/crp56e8fvolm1rqugnkf/web-waf:latest`
Port: `80`

Compose(local) deploy:

```sh
cd deploy
docker compose -p web-scanner up --build -d
```

## Public

Provide zip file: [public/web-waf.zip](public/web-waf.zip).

## TLDR

WAF bypass by providing two "Content-Type" headers.

## Writeup (ru)

### Авторское решение.

#### SQL injection + WAF bypass.

В задаче есть WAF на основе OpenResty, который пытается заблокировать запрос, если находит в нем недопустымые символы.

WAF умеет проверять Content-Type, чтобы проверять тело запроса в зависимости от типа данных.

Под WAF находится приложение, уязвимое к SQL-injection. Приложение также поддерживает 2 вида
Content-Type: `application/json` и `application/x-www-form-urlencoded`.

Уязвимость заключается в том, что код WAF не ожидает что заголовок Content-Type может встретиться дважды.
В таком случае, функция [get_headers](https://github.com/openresty/lua-nginx-module#ngxreqget_headers) возвращает список
строк, а не строку и WAF не может проверить тело запроса.

Однако, PHP все еще сможет понять такой запрос и мы сможем сделать SQL-injection.

#### RCE.

Далее мы можем получить RCE, т.к. после получения сессии админа с помощью SQL-injection нам будет доступна функция
`exec()`, с помощью которой мы можем записать PHP-shell в файл используя "ATTACH DATABASE".

### Дополнительное решение.

В публичном архиве задания дана БД, в которой в истории команд можно найти пароль от пользователя `admin`.

Зная данный пароль, мы можем сразу перейти к шагу "RCE" из авторского решения.

[Эксплойт](solve/vzlom.py)

## Writeup (en)

TODO

[Эксплойт](solve/vzlom.py)

## Domain

Should be auto-generated by Whale.

## Cloudflare

No

## Flag

Should be auto-generated by Whale.
